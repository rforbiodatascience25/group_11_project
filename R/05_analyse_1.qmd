---
title: "05_analyse_1"
format: html
---

```{r}
#| message: false

library(tidyverse)
library(ggplot2)
aug_exp <- read_csv("../data/03_expression_augment_data.csv")
```

```{r}
#| cache: true
aug_exp |> 
  #slice_head(n = 20) |> 
  pivot_longer(cols = -X,
               names_to = "sample",
               values_to = "expression") |> 
  pivot_wider(names_from = X,
              values_from = expression) |> 
  column_to_rownames(var = "sample") |> 
  cor() |> 
  as.data.frame() |> 
  rownames_to_column(var = "transcript1") |> 
  pivot_longer(cols = -transcript1,
               names_to = "transcripts",
               values_to = "correlation") |> 

  ggplot( mapping = aes(x = transcripts,
                        y = transcript1,
                        fill = correlation))+
  geom_tile()+
  scale_fill_gradient2(
    limits = c(-1,1),
    midpoint = 0,
    low = "black",
    mid = "white",
    high = "red"
  )+
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  labs(title = "Co-expression of transcripts")

```

```{r}
#| warning: false
library("DESeq2")
```

```{r}

library(tidyr)
library(dplyr)

ri_metadata_2 = ri_metadata |>
  rename(id = "GC.code")


count_data_wide <- read_csv("../data/03_expression_augment_data.csv")

count_data_long <- count_data_wide %>%
  pivot_longer(
    cols = -X,        
    names_to = "column",
    values_to = "value"     
  ) %>%
  rename(row = X)

samples <- unique(count_data_long$column)
ri_metadata_filtered <- ri_metadata[ri_metadata$GC.code %in% samples, ]
rownames(ri_metadata_filtered) <- ri_metadata_filtered$GC.code
setdiff(samples, rownames(ri_metadata_filtered))


dds <- DESeqDataSetFromMatrix(countData=count_data_long, 
                              colData=ri_metadata_filtered, 
                              design=~Time, tidy = TRUE)
```

```{r}
library(tidyr)
library(dplyr)
library(DESeq2)

# 1. Prepare metadata
ri_metadata_2 <- ri_metadata |>
  rename(id = "GC.code")

# 2. Read and prepare count data (keep it in WIDE format)
count_data_wide <- read_csv("../data/03_expression_augment_data.csv")

# Convert to matrix with proper row names
count_matrix <- as.matrix(count_data_wide[,-1])  # Remove first column (assuming it's gene names)
storage.mode(count_matrix) <- "integer"
rownames(count_matrix) <- count_data_wide$X      # Set row names from first column
colnames(count_matrix) <- colnames(count_data_wide)[-1]  # Column names should be sample IDs

# 3. Verify sample matching
samples <- colnames(count_matrix)
ri_metadata_filtered <- ri_metadata_2[ri_metadata_2$id %in% samples, ]

# Set row names of metadata to match column names of count matrix
rownames(ri_metadata_filtered) <- ri_metadata_filtered$id

# 4. Check for mismatches
missing_in_metadata <- setdiff(samples, rownames(ri_metadata_filtered))
missing_in_counts <- setdiff(rownames(ri_metadata_filtered), samples)

print(paste("Samples in counts but not in metadata:", paste(missing_in_metadata, collapse=", ")))
print(paste("Samples in metadata but not in counts:", paste(missing_in_counts, collapse=", ")))

# 5. Ensure perfect matching by reordering and subsetting
common_samples <- intersect(samples, rownames(ri_metadata_filtered))
count_matrix <- count_matrix[, common_samples, drop=FALSE]
ri_metadata_filtered <- ri_metadata_filtered[common_samples, , drop=FALSE]

ri_metadata_filtered$Time <- factor(ri_metadata_filtered$Time)

# 6. Verify dimensions match
print(paste("Count matrix dimensions:", paste(dim(count_matrix), collapse=" x ")))
print(paste("Metadata dimensions:", paste(dim(ri_metadata_filtered), collapse=" x ")))

# 7. Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = count_matrix, 
                              colData = ri_metadata_filtered, 
                              design = ~ Time)

```

```{r}
dds <- DESeq(dds)
```

```{r}
res <- results(dds)
head(results(dds, tidy=TRUE))
```

```{r}
res <- res[order(res$padj),]
head(res)
```

```{r}
library(ggrepel)
res |> 
  ggplot(aes(x = log2FoldChange, y = -log10(pvalue))) +
  geom_point(aes(), alpha = 0.5)+  # color = is_significant
  geom_text_repel(data = res,
            aes(x = log2FoldChange,
                y = pvalue, label = rownames(res)),
            size = 3,
            color = "cadetblue"
            )+
  labs(x = "log2FoldChange",
       y = "-log10(p)",
       title = "fix",
       subtitle = "fux")+
  theme(legend.position = "none")
```
