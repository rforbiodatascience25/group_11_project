---
title: "05_analyse_1"
format: html
---

# Analysis I

```{r}
library(tidyverse)
library(ggplot2)
library(tidyr)
library(dplyr)
library(DESeq2)
library(EnhancedVolcano)
library(ggrepel)
```

## Co-Expression of Transcripts

```{r}
#| message: false
aug_exp <- read_csv("../data/03_expression_data_augment.csv")
```

```{r}
#| cache: true
aug_exp |> 
  #slice_head(n = 20) |> 
  pivot_longer(cols = -X,
               names_to = "sample",
               values_to = "expression") |> 
  pivot_wider(names_from = X,
              values_from = expression) |> 
  column_to_rownames(var = "sample") |> 
  cor() |> 
  as.data.frame() |> 
  rownames_to_column(var = "transcript1") |> 
  pivot_longer(cols = -transcript1,
               names_to = "transcripts",
               values_to = "correlation") |> 

  ggplot( mapping = aes(x = transcripts,
                        y = transcript1,
                        fill = correlation))+
  geom_tile()+
  scale_fill_gradient2(
    limits = c(-1,1),
    midpoint = 0,
    low = "black",
    mid = "white",
    high = "red"
  )+
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  labs(title = "Co-expression of transcripts")

```

## DESeq

### Preparation

```{r}

ri_metadata_2 <- ri_metadata |>
  dplyr::rename(id = "GC.code")

count_data_wide <- read_csv("../data/03_expression_data_augment.csv")

count_matrix <- as.matrix(count_data_wide[,-1])  
storage.mode(count_matrix) <- "integer"
rownames(count_matrix) <- count_data_wide$X
colnames(count_matrix) <- colnames(count_data_wide)[-1]

samples <- colnames(count_matrix)
ri_metadata_filtered <- ri_metadata_2[ri_metadata_2$id %in% samples, ]

# Set row names of metadata to match column names of count matrix
rownames(ri_metadata_filtered) <- ri_metadata_filtered$id

# Check mismatches
missing_in_metadata <- setdiff(samples, rownames(ri_metadata_filtered))
missing_in_counts <- setdiff(rownames(ri_metadata_filtered), samples)

print(paste("Samples in counts but not in metadata:", paste(missing_in_metadata, collapse=", ")))
print(paste("Samples in metadata but not in counts:", paste(missing_in_counts, collapse=", ")))

# Ensure perfect matching by reordering and subsetting
common_samples <- intersect(samples, rownames(ri_metadata_filtered))
count_matrix <- count_matrix[, common_samples, drop=FALSE]
ri_metadata_filtered <- ri_metadata_filtered[common_samples, , drop=FALSE]

ri_metadata_filtered$Time <- factor(ri_metadata_filtered$Time)

# Verify dimensions match
print(paste("Count matrix dimensions:", paste(dim(count_matrix), collapse=" x ")))
print(paste("Metadata dimensions:", paste(dim(ri_metadata_filtered), collapse=" x ")))

# Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = count_matrix, 
                              colData = ri_metadata_filtered, 
                              design = ~ Time)

```
### Computation

```{r}

# Run DESeq
dds <- DESeq(dds)
res <- results(dds)

# and show some of the results
head(results(dds, tidy=TRUE))
res <- res[order(res$padj),]
head(res)
```

### Volcano Plot

```{r}
# Generate a Volcano Plot
volcano <- EnhancedVolcano(res,
  lab = rownames(res),
  x = 'log2FoldChange',
  y = 'pvalue',
  pCutoff = 10e-4,
  FCcutoff = 1.333,
  xlim = c(-5.5, 5.5),
  ylim = c(0, -log10(10e-12)),
  pointSize = 1.5,
  labSize = 2.5,
  title = 'DESeq2 results',
  subtitle = 'Differential expression',
  caption = 'FC cutoff, 1.333; p-value cutoff, 10e-4',
  legendPosition = "bottom",
  legendLabSize = 14,
  col = c('grey30', 'forestgreen', 'royalblue', 'red2'),
  colAlpha = 0.9,
  drawConnectors = TRUE,
  hline = c(10e-8),
  widthConnectors = 0.5)
volcano
```

### Volcano Plot (no external packages)

```{r}
df <- as.data.frame(res)
df$gene <- rownames(df)

fc_cutoff <- 1.333
p_cutoff <- 10e-4

df <- df |>
  mutate(category = case_when(
    pvalue < p_cutoff & abs(log2FoldChange) > fc_cutoff ~ "Both",
    pvalue < p_cutoff ~ "P-value",
    abs(log2FoldChange) > fc_cutoff ~ "Log2 FC",
    TRUE ~ "NS"
  )) |>
  mutate(category = factor(category, levels = c("NS", "Log2 FC", "P-value", "Both")))

ggplot(df, aes(x = log2FoldChange, y = -log10(pvalue))) +
  geom_point(aes(color = category), alpha = 0.9, size = 1.5) +
  scale_color_manual(values = c("NS" = "grey30", 
                                "Log2 FC" = "forestgreen", 
                                "P-value" = "royalblue", 
                                "Both" = "red2")) +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff), linetype = "dashed", color = "black", alpha = 0.5) +
  geom_hline(yintercept = -log10(p_cutoff), linetype = "dashed", color = "black", alpha = 0.5) +
  geom_hline(yintercept = -log10(10e-8), linetype = "dotted", color = "black") +
  geom_text_repel(
    data = subset(df, category == "Both"),
    aes(label = gene),
    size = 2.5,
    min.segment.length = 0, 
    segment.size = 0.5
  ) +
  
  xlim(-5.5, 5.5) +
  ylim(0, -log10(10e-12)) +
  labs(
    title = "DESeq2 results",
    subtitle = "Differential expression",
    caption = "FC cutoff, 1.333; p-value cutoff, 10e-4",
    x = "log2FoldChange",
    y = "-Log10 P-value"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 14)
  )


ggsave("../results/volcano.png", plot = volcano, device = 'png')
```

### Top 6 Expressed Genes

```{r}
res12 <- results(dds, contrast=c("Time","12","4"))
res48 <- results(dds, contrast=c("Time","48","4"))

res12 <- res12[order(res12$padj), ]
res48 <- res48[order(res48$padj), ]

top_genes <- rownames(res12)[1:6]

norm_counts <- counts(dds, normalized=TRUE)
top_counts <- norm_counts[top_genes, ]

top_counts_df <- as.data.frame(top_counts) |>
  rownames_to_column(var="Gene") |>
  pivot_longer(-Gene, names_to="Sample", values_to="Expression")

sample_info <- as.data.frame(colData(dds)) |>
  select(Time) |>
  rownames_to_column(var="Sample")

top_counts_df <- top_counts_df |>
  left_join(sample_info, by="Sample")

top_counts <- ggplot(top_counts_df, aes(x=Time, y=Expression, fill=Time)) +
  geom_bar(stat="identity", position="dodge") +
  facet_wrap(~Gene, scales="free_y") +
  theme_minimal() +
  labs(title="Top 6 Differentially Expressed Genes Across Time Points",
       y="Normalized Expression")

ggsave("../results/topcounts.png", plot = top_counts, device = 'png')

```
